version: "3"

networks:
  traefik-proxy:
    external: true
  db-network:
    internal: true

services:
  redis:
    image: redis:alpine
    command: redis-server --requirepass {{ nextcloud_redis_password }}
    networks:
      - db-network
    restart: unless-stopped
  db:
    image: postgres:{{ nextcloud_db_docker_image_tag }}
    networks:
      - db-network
    restart: unless-stopped
    volumes:
      - /mnt/{{ hostname }}-volume/nextcloud/db/var/lib/postgresql/data:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
    environment:
      - POSTGRES_USER={{ nextcloud_postgres_user|default("nextcloud") }}
      - POSTGRES_PASSWORD={{ nextcloud_postgres_password }}
      - POSTGRES_DB={{ nextcloud_postgres_db|default("nextcloud") }}
  app:
    depends_on:
      - db
      - redis
    image: nextcloud:{{ nextcloud_docker_image_tag }}
    networks:
      - traefik-proxy
      - db-network
    labels:
      - "traefik.enable=true"
      - traefik.http.routers.nextcloud.rule=Host(`{{ nextcloud_domain }}`)
{% if nextcloud_https|default("disabled") == "enabled" %}
      - traefik.http.routers.nextcloud.middlewares=nextcloud,nextcloud_redirect
      - traefik.http.middlewares.nextcloud.headers.stsSeconds=155520011
      - traefik.http.routers.nextcloud.entrypoints=https
      - traefik.http.routers.nextcloud.tls=true
      - traefik.http.routers.nextcloud.tls.certresolver=le-resolver
{% else %}
      - traefik.http.routers.nextcloud.middlewares=nextcloud_redirect
      - traefik.http.routers.nextcloud.entrypoints=http
{% endif %}
      - traefik.http.middlewares.nextcloud_redirect.redirectregex.regex=/.well-known/(card|cal)dav
      - traefik.http.middlewares.nextcloud_redirect.redirectregex.replacement=/remote.php/dav/
      - traefik.http.services.nextcloud.loadbalancer.server.port=80
    restart: unless-stopped
    volumes:
      - /mnt/{{ hostname }}-volume/nextcloud/data:/var/www/html
    environment:
      - POSTGRES_USER={{ nextcloud_postgres_user|default("nextcloud") }}
      - POSTGRES_PASSWORD={{ nextcloud_postgres_password }}
      - POSTGRES_DB={{ nextcloud_postgres_db|default("nextcloud") }}
      - POSTGRES_HOST=db
      - NEXTCLOUD_TRUSTED_DOMAINS={{ nextcloud_domain }}
      - TRUSTED_PROXIES=172.19.0.0/16
{% if nextcloud_https|default("disabled") == "enabled" %}
      - OVERWRITEPROTOCOL=https
{% else %}
      - OVERWRITEPROTOCOL=http
{% endif %}
      - REDIS_HOST=redis
      - REDIS_HOST_PASSWORD={{ nextcloud_redis_password }}
{% if nextcloud_main_storage_s3|default("disabled") == "enabled" %}
{% if nextcloud_s3_host is defined %}
      - OBJECTSTORE_S3_HOST={{ nextcloud_s3_host }}
{% endif %}
      - OBJECTSTORE_S3_REGION={{ nextcloud_s3_region }}
      - OBJECTSTORE_S3_BUCKET={{ nextcloud_s3_bucket }}
      - OBJECTSTORE_S3_KEY={{ nextcloud_s3_key }}
      - OBJECTSTORE_S3_SECRET={{ nextcloud_s3_secret }}
      - OBJECTSTORE_S3_PORT={{ nextcloud_s3_port|default(443) }}
      - OBJECTSTORE_S3_SSL={{ nextcloud_s3_ssl|default("true") }}
      - OBJECTSTORE_S3_USEPATH_STYLE={{ nextcloud_s3_usepath_style|default("false") }}
{% endif %}
  cron:
    image: nextcloud:{{ nextcloud_docker_image_tag }}
    networks:
      - traefik-proxy
      - db-network
    restart: always
    volumes:
      - /mnt/{{ hostname }}-volume/nextcloud/data:/var/www/html
    environment:
      - POSTGRES_USER={{ nextcloud_postgres_user|default("nextcloud") }}
      - POSTGRES_PASSWORD={{ nextcloud_postgres_password }}
      - POSTGRES_DB={{ nextcloud_postgres_db|default("nextcloud") }}
      - POSTGRES_HOST=db
      - REDIS_HOST=redis
      - REDIS_HOST_PASSWORD={{ nextcloud_redis_password }}
{% if nextcloud_main_storage_s3|default("disabled") == "enabled" %}
{% if nextcloud_s3_host is defined %}
      - OBJECTSTORE_S3_HOST={{ nextcloud_s3_host }}
{% endif %}
      - OBJECTSTORE_S3_REGION={{ nextcloud_s3_region }}
      - OBJECTSTORE_S3_BUCKET={{ nextcloud_s3_bucket }}
      - OBJECTSTORE_S3_KEY={{ nextcloud_s3_key }}
      - OBJECTSTORE_S3_SECRET={{ nextcloud_s3_secret }}
      - OBJECTSTORE_S3_PORT={{ nextcloud_s3_port|default(443) }}
      - OBJECTSTORE_S3_SSL={{ nextcloud_s3_ssl|default("true") }}
      - OBJECTSTORE_S3_USEPATH_STYLE={{ nextcloud_s3_usepath_style|default("false") }}
{% endif %}
    entrypoint: /cron.sh
    depends_on:
      - db
      - redis